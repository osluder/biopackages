#$Id: perl-DAS2-chado.spec.in,v 1.2 2006/02/10 11:40:43 boconnor Exp $
Distribution: Custom
Vendor: biopackages.net
Summary: Distributed Annotation System
Name: perl-DAS2-chado
Version: 2.001
Release: %{revision}.%{distro}
Packager: boconnor@ucla.edu
License: GPL or Artistic
Group: Development/Libraries
URL: http://www.biodas.org/
BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root
BuildRequires: perl, biopackages
Requires: httpd, httpd-devel, perl, mod_perl, perl-Apache-ParseFormData, perl-DBI, perl-DBD-Pg, perl-libwww-perl, perl-PDL, perl-Template-Toolkit, perl-URI, perl-bioperl, perl-Log-Log4perl, perl-PDL-NetCDF, perl-Package-Tools, perl-Crypt-SSLeay, perl-Devel-Symdump, perl-HTML-Tagset, perl-HTML-Parser, gbrowse, perl-Bio-MAGE, perl-Devel-CoreStack, perl-IPC-Run3

Source0: Distributed-Annotation-System-%{version}.tar.gz

%description
A DAS/2 server that connects to a Chado database instance.

Running the following commands in the source directory (cvs or tarball) setup a test server:
> perl Makefile.PL
> make
> make test

If successful, this should bring up a httpd process running on port 8529.
If you would like to use an alternate port, set $APACHE_PORT to the port
number you'd like to use before running 'make test', for example with
bash, this runs the test suite on port 8000

> APACHE_PORT=8000 make test

If you are installing directly from source (cvs or tarball) please set the following
environment variables before running "make install".

These variables should be in all caps.

> export target_web_dir=/var/www/das2
> export species=human
> export species_version=17
> export species_abbr=Hsa
> export db_name=chado-Hsa-17
> export db_user=readonly
> export db_pass=readonly
> export db_host=localhost

%prep
%setup -q -n Distributed-Annotation-System-%{version}

%build
CFLAGS="$RPM_OPT_FLAGS" perl Makefile.PL PREFIX=$RPM_BUILD_ROOT%{_prefix}  < /dev/null
make OPTIMIZE="$RPM_OPT_FLAGS"

%install
rm -rf $RPM_BUILD_ROOT

eval `perl '-V:installarchlib'`
mkdir -p $RPM_BUILD_ROOT$installarchlib
export TARGET_WEB_DIR=$RPM_BUILD_ROOT/var/www/das/Sce
export SPECIES=yeast
export SPECIES_VERSION=S228C
export SPECIES_ABBR=Sce
export DB_NAME=chado-Sce-S228C
export DB_USER=readonly
export DB_PASS=readonly
export DB_HOST=localhost
%makeinstall

find $RPM_BUILD_ROOT -type f -a \( -name perllocal.pod -o -name .packlist \
  -o \( -name '*.bs' -a -empty \) \) -exec rm -f {} ';'
find $RPM_BUILD_ROOT -type d -depth -exec rmdir {} 2>/dev/null ';'
chmod -R u+w $RPM_BUILD_ROOT/*

[ -x /usr/lib/rpm/brp-compress ] && /usr/lib/rpm/brp-compress

find $RPM_BUILD_ROOT -type f \
| sed "s@^$RPM_BUILD_ROOT@@g" \
> %{name}-%{version}-%{release}-filelist

eval `perl -V:archname -V:installsitelib -V:installvendorlib -V:installprivlib`
for d in $installsitelib $installvendorlib $installprivlib; do
  [ -z "$d" -o "$d" = "UNKNOWN" -o ! -d "$RPM_BUILD_ROOT$d" ] && continue
  find $RPM_BUILD_ROOT$d/* -type d \
  | grep -v "/$archname\(/auto\)\?$" \
  | sed "s@^$RPM_BUILD_ROOT@%dir @g" \
  >> %{name}-%{version}-%{release}-filelist
done

if [ "$(cat %{name}-%{version}-%{release}-filelist)X" = "X" ] ; then
    echo "ERROR: EMPTY FILE LIST"
    exit 1
fi

%clean
rm -rf $RPM_BUILD_ROOT

%files -f %{name}-%{version}-%{release}-filelist
%defattr(-,root,root,-)

%post
cp /etc/httpd/conf/httpd.conf /etc/httpd/conf/httpd.conf.rpmsave
echo 'Include /var/www/das/Sce/conf/httpd.conf' >> /etc/httpd/conf/httpd.conf
/etc/init.d/httpd restart

%changelog
* Fri Feb 10 2006 boconnor@ucla.edu - 2.001-1.1
- Specfile autogenerated.
